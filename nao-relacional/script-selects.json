result = bd.produto.aggregate([
    {"$unwind": "$avaliacao"},
    {"$lookup": {
        "from": "categoria",
        "localField": "id_categoria",
        "foreignField": "_id",
        "as": "categoria"
    }},
    {"$unwind": "$categoria"},
    {"$group": {
        "_id": "$categoria.nome",
        "Media_Nota": {"$avg": "$avaliacao.nota"},
        "Media_Precos": {"$avg": "$preco"}
    }},
    {"$project": {
        "_id": 0,
        "nome": "$_id",
        "Media_Nota": 1,
        "Media_Precos": 1
    }}
])
for r in result:
  print(f"Categoria: {r['nome']} | Média avaliações: {round(r['Media_Nota'], 1)} | Média preços: {round(r['Media_Precos'], 2)}")

result = bd.produto.aggregate([
    {"$unwind": "$avaliacao"},
    {"$group": {
        "_id": {"nome": "$nome", "preco": "$preco"},
        "Media_Nota": {"$avg": "$avaliacao.nota"}
    }},
    {"$project": {
        "nome": "$_id.nome",
        "preco": "$_id.preco",
        "Media_Nota": 1
    }}
])
for r in result:
    print(f"Produto: {r['nome']} | Nota: {round(r['Media_Nota'], 1)} | Preço: {round(r['preco'], 2)}")

result = bd.produto.aggregate([{"$unwind": "$avaliacao"},
    {"$lookup": {
        "from": "categoria",
        "localField": "id_categoria",
        "foreignField": "_id",
        "as": "categoria"
    }},
    {"$unwind": "$categoria"},
    {"$project": {
        "_id": 0,
        "nota": "$avaliacao.nota",
        "comentario": "$avaliacao.comentario",
        "produto": "$nome",
        "preco": "$preco",
        "categoria": "$categoria.nome"
    }}])
for r in result:
    print(f"Produto: {r['produto']} | Nota: {round(r['nota'], 1)} | Preço: {round(r['preco'], 2)} | Comentário: {r['comentario']} | Categoria: {r['categoria']}")

top_vendidos = list(bd.pedido.aggregate([
    {"$unwind": "$item"},
    {"$group": {
        "_id": "$item.id_produto",
        "total_vendas": {"$sum": "$item.quantidade"}
    }},
    {"$sort": {"total_vendas": -1}},
    {"$limit": 5}
]))
top_vendidos_ids = [produto["_id"] for produto in top_vendidos]

result = bd.produto.aggregate([
    {"$match": {"_id": {"$in": top_vendidos_ids}}},
    {"$unwind": "$avaliacao"},
    {"$group": {
        "_id": "$_id",
        "nome": {"$first": "$nome"},
        "Media_Nota": {"$avg": "$avaliacao.nota"},
        "Media_Precos": {"$first": "$preco"}
    }},
    {"$project": {
        "_id": 0,
        "nome": "$nome",
        "Media_Nota": 1,
        "Media_Precos": 1
    }}
])

for r in result:
    print(f"Produto: {r['nome']} | Média avaliações: {round(r['Media_Nota'], 1)} | Média preços: {round(r['Media_Precos'], 2)}")